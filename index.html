<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Media (Firefox) com Navegação Lateral</title>
    <link id="favicon" rel="icon" href="#">
    <link rel="stylesheet" href="style.css">
    </head>
<body class="initial-load">

<script>
    const THEME_KEY='randomMediaViewerTheme',SPEED_DIAL_CONFIG_KEY='randomMediaSpeedDialConfig';function applyPersistedTheme(){try{const s=localStorage.getItem(THEME_KEY);s==='light'?document.body.classList.add('light-theme'):document.body.classList.remove('light-theme')}catch(s){console.error('Failed to access localStorage for theme:',s)}}applyPersistedTheme();
</script>

<div id="cover-overlay-blur"></div>
<div id="cover-overlay"></div>
<h1 id="main-header-title">Random Media</h1>

<div id="caminho-sidebar">
    <button id="caminho-sidebar-close-btn" title="Fechar Barra Lateral">&times;</button>
    <h3 id="caminho-sidebar-title">Navegação Rápida</h3>
    <ul id="caminho-sidebar-list">
        </ul>
</div>

<div id="speed-dial-container">
    <div id="speed-dial-title">Bem-vindo!</div>
    <div id="lucky-feature-container" style="display: none;">
        <div id="lucky-image-wrapper" style="display: none; cursor: pointer;">
            <img id="lucky-image" src="#" alt="Imagem da sorte">
            <div id="lucky-image-text" style="display: none;"></div>
        </div>
    </div>
    <div id="speed-dial-subtitle">Para começar, selecione a pasta principal "Nucleo" que contém seus arquivos e as subpastas "Caminho".</div>
    <button id="select-nucleo-folder">Selecionar Pasta "Nucleo"</button>
    <div id="speed-dial-status" aria-live="polite"></div>
    <div id="speed-dial-options"></div>
    <input type="file" id="folder-input" webkitdirectory directory multiple>
</div>
<div class="controls-container">
    <button id="return-to-speed-dial">Voltar ao Início</button>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Pesquisar capas por prefixo..." autocomplete="off" aria-controls="search-suggestions" aria-haspopup="listbox">
        <div id="search-suggestions" role="listbox"></div>
    </div>
    <button id="new-media">Nova Mídia Aleatória</button>
    <button id="theme-toggle-button">Modo Claro/Escuro</button>
</div>
<div id="loading-indicator" aria-live="polite"></div>
<div id="media-container"></div>
<div id="fullscreen-media" onclick="closeFullscreenMedia()">
     <button id="rotate-button" title="Rotacionar" onclick="rotateImage(event)">↻</button>
     <img id="fullscreen-img" src="" alt="Imagem em Tela Cheia" style="display:none;" onclick="event.stopPropagation()">
     <video id="fullscreen-video" controls style="display:none;" onclick="event.stopPropagation()"></video>
</div>

<script>
    'use strict';
    let mediaFiles=[],mediaIndex=new Map(),globalMediaIndex=new Map(),initialViewHistory=[],sessionViewedPrefixes=new Set(),rotationAngle=0,zoomScale=1,imgOffsetX=0,imgOffsetY=0,isDragging=!1,dragStartX=0,dragStartY=0,dragStartOffsetX=0,dragStartOffsetY=0,isLoading=!1,currentOperationController=null,allSelectedFiles=null,rootDirName='',iconBlobUrls=new Map(),faviconBlobUrl=null,speedDialConfig=[];
    let coverOverlayBlur,coverOverlay,mediaContainerEl,loadingIndicatorEl,newMediaButton,themeToggleButton,speedDialContainerEl,selectNucleoButtonEl,speedDialOptionsEl,speedDialStatusEl,faviconElement,folderInputEl,fullscreenMediaEl,fullscreenImgEl,fullscreenVideoEl,rotateButtonEl,searchInputEl,searchSuggestionsEl,draggedItemOriginalName=null,returnToSpeedDialButton, controlsContainerEl;
    let luckyFeatureContainerEl, luckyImageWrapperEl, luckyImageEl, luckyImageTextEl;
    let suggestionAbortController = null;
    let currentLuckyFileItem=null, luckyImageBlobUrl=null, luckyFeatureState='initial';
    let mainHeaderTitleEl; // Variável para o H1 principal

    // Sidebar elements
    let caminhoSidebarEl, caminhoSidebarListEl, caminhoSidebarTitleEl, caminhoSidebarCloseBtnEl;

    const THUMB_ANIM_DELAY_STAGGER=90,COVER_DISPLAY_DELAY=1500,MAX_FILTERED_ITEMS=25,MAX_INITIAL_ITEMS=32,INITIAL_HISTORY_SIZE_LIMIT=MAX_INITIAL_ITEMS*3,ORIGINAIS_FOLDER_NAME='originais',CAPAS_FOLDER_NAME='.capas',CAMINHO_FOLDER_NAMES=Array.from({length:25},(_,i)=>`Caminho ${i+1}`),MAX_SEARCH_SUGGESTIONS=10,MIN_ZOOM=.1,MAX_ZOOM=20,ZOOM_SENSITIVITY=1.1;
    const ICON_NAME_REGEX = /^(icon\d+|fav)\.(jpe?g|png|avif)$/i;

    const delay=(m,s)=>new Promise((r,j)=>{if(s?.aborted)return j(new DOMException('Delay cancelled before start','AbortError'));const l=()=>{clearTimeout(t);j(new DOMException('Delay cancelled','AbortError'))},t=setTimeout(()=>{s?.removeEventListener('abort',l);r()},m);s?.addEventListener('abort',l,{once:!0})});
    function isMediaFile(f){return /\.(jpe?g|png|gif|mp4|mkv|webm|avif)$/i.test(f)}
    function isImageFile(f){return /\.(jpe?g|png|gif|avif)$/i.test(f)}
    function getRandomMedia(m,c){const s=[...m],l=s.length,n=Math.min(c,l);if(n===0)return[];for(let i=l-1;i>=l-n;i--){const k=Math.floor(Math.random()*(i+1));[s[i],s[k]]=[s[k],s[i]]}return s.slice(l-n)}
    function getFirstTwoWords(f){if(!f)return'';const n=f.substring(0,f.lastIndexOf('.'))||f,w=n.split(/[\s_.-]+/).filter(Boolean);return w.slice(0,2).join(' ').trim()||n}
    function revokeItemResources(i){if(!i)return;if(i.blobUrl?.startsWith('blob:')){try{URL.revokeObjectURL(i.blobUrl)}catch(e){}}i.blobUrl=null;i.fileRef=null;i.loadSuccess=null;i.abortController?.abort();i.abortController=null}
    function getRandomInitialMedia(availableFiles,count){if(!availableFiles||availableFiles.length===0)return[];const historySet=new Set(initialViewHistory);let eligibleFiles=availableFiles.filter(f=>f.relativePath&&!historySet.has(f.relativePath));if(eligibleFiles.length===0&&availableFiles.length>0){eligibleFiles=[...availableFiles]}if(eligibleFiles.length===0)return[];const prefixToFileMap=new Map();for(const file of eligibleFiles){if(!file.prefix)continue;if(!prefixToFileMap.has(file.prefix)){prefixToFileMap.set(file.prefix,[])}prefixToFileMap.get(file.prefix).push(file)}if(prefixToFileMap.size===0){const fallbackSelected=getRandomMedia(eligibleFiles,count);const fallbackPaths=fallbackSelected.map(f=>f.relativePath).filter(Boolean);initialViewHistory.unshift(...fallbackPaths);if(initialViewHistory.length>INITIAL_HISTORY_SIZE_LIMIT){initialViewHistory.length=INITIAL_HISTORY_SIZE_LIMIT}for(const file of fallbackSelected){if(file.prefix){sessionViewedPrefixes.add(file.prefix)}}return fallbackSelected}let G_eligiblePrefixes=Array.from(prefixToFileMap.keys());let H_preferredPrefixes=G_eligiblePrefixes.filter(p=>!sessionViewedPrefixes.has(p));let I_prefixesToUseThisRound;if(H_preferredPrefixes.length>0){I_prefixesToUseThisRound=H_preferredPrefixes}else{sessionViewedPrefixes.clear();I_prefixesToUseThisRound=G_eligiblePrefixes}for(let i=I_prefixesToUseThisRound.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[I_prefixesToUseThisRound[i],I_prefixesToUseThisRound[j]]=[I_prefixesToUseThisRound[j],I_prefixesToUseThisRound[i]]}const resultFiles=[];const selectedRelativePathsThisRun=new Set();for(const prefix of I_prefixesToUseThisRound){if(resultFiles.length>=count)break;const filesForThisPrefix=prefixToFileMap.get(prefix);if(filesForThisPrefix&&filesForThisPrefix.length>0){const K_availableFilesInPrefix=filesForThisPrefix.filter(f=>!selectedRelativePathsThisRun.has(f.relativePath));if(K_availableFilesInPrefix.length>0){const L_randomIndex=Math.floor(Math.random()*K_availableFilesInPrefix.length);const M_selectedFile=K_availableFilesInPrefix[L_randomIndex];resultFiles.push(M_selectedFile);selectedRelativePathsThisRun.add(M_selectedFile.relativePath);sessionViewedPrefixes.add(M_selectedFile.prefix)}}}if(resultFiles.length<count){const N_remainingEligibleFiles=eligibleFiles.filter(f=>!selectedRelativePathsThisRun.has(f.relativePath));if(N_remainingEligibleFiles.length>0){const O_neededCount=count-resultFiles.length;const P_additionalFiles=getRandomMedia(N_remainingEligibleFiles,O_neededCount);for(const file of P_additionalFiles){if(resultFiles.length>=count)break;resultFiles.push(file);selectedRelativePathsThisRun.add(file.relativePath);if(file.prefix)sessionViewedPrefixes.add(file.prefix)}}}const Q_resultPaths=resultFiles.map(f=>f.relativePath).filter(Boolean);initialViewHistory.unshift(...Q_resultPaths);if(initialViewHistory.length>INITIAL_HISTORY_SIZE_LIMIT){initialViewHistory.length=INITIAL_HISTORY_SIZE_LIMIT}return resultFiles}
    function setSpeedDialStatus(m,e=!1){if(!speedDialStatusEl)return;speedDialStatusEl.textContent=m;speedDialStatusEl.classList.toggle('error',e)}
    function beginOperation(){if(currentOperationController){currentOperationController.abort()}currentOperationController=new AbortController();isLoading=!0;if(selectNucleoButtonEl)selectNucleoButtonEl.disabled=!0;if(newMediaButton)newMediaButton.disabled=!0;if(themeToggleButton)themeToggleButton.disabled=!0;if(searchInputEl)searchInputEl.disabled=!0;if(returnToSpeedDialButton)returnToSpeedDialButton.disabled=!0;if(speedDialOptionsEl){speedDialOptionsEl.querySelectorAll('.speed-dial-item').forEach(i=>{i.style.pointerEvents='none';i.setAttribute('aria-disabled','true')})}return currentOperationController.signal}
    function endOperation(s=!0){if(!isLoading&&!currentOperationController)return;isLoading=!1;currentOperationController=null;if(selectNucleoButtonEl)selectNucleoButtonEl.disabled=!1;const i=!document.body.classList.contains('initial-load')&&(!speedDialContainerEl||speedDialContainerEl.style.display==='none');if(returnToSpeedDialButton){returnToSpeedDialButton.style.display=i?'inline-block':'none';returnToSpeedDialButton.disabled=!1}if(i){const h=mediaFiles.some(t=>!t.isCoverFile),c=mediaFiles.some(t=>t.isCoverFile);if(searchInputEl)searchInputEl.disabled=!(allSelectedFiles&&c);if(newMediaButton){newMediaButton.style.display=h?'inline-block':'none';newMediaButton.disabled=!h}if(controlsContainerEl) controlsContainerEl.style.display = 'flex';
    }else{if(newMediaButton)newMediaButton.style.display='none';if(searchInputEl)searchInputEl.disabled=!0;if(controlsContainerEl) controlsContainerEl.style.display = 'none'; hideCaminhoSidebar(); 
    }if(themeToggleButton)themeToggleButton.disabled=!1;if(allSelectedFiles&&speedDialOptionsEl){speedDialOptionsEl.querySelectorAll('.speed-dial-item').forEach(t=>{t.style.pointerEvents='auto';t.removeAttribute('aria-disabled')})}}
    function cleanupUIState(){clearTimeout(window.coverDisplayTimeoutId||0);if(coverOverlayBlur){coverOverlayBlur.classList.remove('visible');coverOverlayBlur.style.backgroundImage='none'}if(coverOverlay){coverOverlay.classList.remove('visible');coverOverlay.style.backgroundImage='none'}if(document.body)document.body.classList.remove('cover-active');if(mediaContainerEl){mediaContainerEl.innerHTML='';mediaContainerEl.classList.remove('view-initial','view-filtered')}if(loadingIndicatorEl)loadingIndicatorEl.style.display='none';if(searchSuggestionsEl){searchSuggestionsEl.innerHTML='';searchSuggestionsEl.style.display='none'}if(searchInputEl)searchInputEl.value=''; hideCaminhoSidebar();}
    function buildMediaIndex(s){if(s.aborted)throw new DOMException('Index cancelled','AbortError');const i=isLoading;isLoading=!0;mediaIndex.clear();for(let k=0;k<mediaFiles.length;k++){if(k%500===0&&s.aborted){mediaIndex.clear();isLoading=i;throw new DOMException('Index aborted during build','AbortError')}const t=mediaFiles[k],p=t.prefix?.toLowerCase();if(!p)continue;if(!mediaIndex.has(p)){mediaIndex.set(p,{covers:[],regulars:[]})}const e=mediaIndex.get(p);(t.isCoverFile?e.covers:e.regulars).push(t)}isLoading=i}
    async function ensureFileObjectForItem(i,s){if(s?.aborted)throw new DOMException('Cancelled during file check','AbortError');if(i.fileRef instanceof File){const x=i.name.split('.').pop()?.toLowerCase()||'',t={'jpg':'image/jpeg','jpeg':'image/jpeg','png':'image/png','gif':'image/gif','mp4':'video/mp4','webm':'video/webm','mkv':'video/x-matroska','avif':'image/avif'};i.type=t[x]||i.fileRef.type||'application/octet-stream';return!0}else{i.loadSuccess=!1;i.type='error/missing-ref';console.warn(`Missing file reference for item: ${i.name}`);return!1}}
    async function loadBlobForItem(i,s){if(s?.aborted)throw new DOMException('Cancelled before blob load','AbortError');if(i.blobUrl&&i.loadSuccess===!0)return!0;if(i.loadSuccess===!1)return!1;i.abortController?.abort();i.abortController=new AbortController();const t=i.abortController.signal,c=AbortSignal.any?AbortSignal.any([s,t].filter(Boolean)):(s||t);i.loadSuccess='pending';try{if(!await ensureFileObjectForItem(i,c)){i.loadSuccess=!1;return!1}const f=i.fileRef;if(!f)throw new Error("Missing file reference unexpectedly");if(c?.aborted)throw new DOMException('Cancelled before blob creation','AbortError');if(i.blobUrl&&i.blobUrl.startsWith('blob:')){try{URL.revokeObjectURL(i.blobUrl)}catch(e){}}i.blobUrl=URL.createObjectURL(f);if(c?.aborted){URL.revokeObjectURL(i.blobUrl);i.blobUrl=null;throw new DOMException('Cancelled after blob creation','AbortError')}i.loadSuccess=!0;return!0}catch(e){if(e.name==='AbortError'){i.loadSuccess=null;i.blobUrl=null;if(i.blobUrl?.startsWith('blob:'))try{URL.revokeObjectURL(i.blobUrl)}catch(x){}}else{console.error("Error creating blob for",i.name,e);i.loadSuccess=!1;i.blobUrl=null}return!1}finally{i.abortController=null}}
    async function loadCoverImageBlobUrl(i,s){if(s?.aborted)throw new DOMException('Cancelled loading cover blob','AbortError');if(!i?.isCoverFile)return null;try{return await loadBlobForItem(i,s)?i.blobUrl:null}catch(e){if(e.name==='AbortError')throw e;console.error("Non-abort error loading cover blob:",i.name,e);return null}}
    function buildMediaElement(i){if(!i||i.isCoverFile)return null;const d=document.createElement('div');d.className='media-container-item';if(i.isOriginal){d.classList.add('is-original');const l=document.createElement('span');l.className='original-label';l.textContent='Original';d.appendChild(l)}const c=document.createElement('p');c.onclick=e=>{e.stopPropagation();if(!isLoading)displayGlobalMediaByPrefix(i.prefix)};c.title=i.name;let m;if(i.loadSuccess===!0&&i.blobUrl){if(i.type?.startsWith('image')){m=document.createElement('img');m.src=i.blobUrl;m.alt=i.name;m.loading='lazy'}else if(i.type?.startsWith('video')){m=document.createElement('video');m.src=i.blobUrl;m.muted=!0;m.preload='metadata';m.playsInline=!0}if(m){m.className='media-item';m.onclick=e=>{e.stopPropagation();showFullscreenMedia(i.blobUrl,i.type)};m.onerror=()=>{const p=document.createElement('div');p.className='media-error-placeholder';p.textContent='Render Err';if(m.parentNode)m.parentNode.replaceChild(p,m);i.loadSuccess=!1;revokeItemResources(i);c.textContent=`${i.prefix||'?'} (Render Err)`;d.classList.add('has-error')}}}if(!m){m=document.createElement('div');m.className='media-error-placeholder';let e="Erro";switch(i.loadSuccess){case!1:e=i.type==='error/missing-ref'?'No Ref':(i.type==='error/access'?'No Access':'Load Fail');break;case'pending':e='Carregando...';break;case null:e='Not Loaded';break}m.textContent=e;c.textContent=`${i.prefix||'?'} (${e})`;d.classList.add('has-error')}d.appendChild(m);c.textContent=c.textContent||i.prefix||'?';d.appendChild(c);return d}
    async function ensureMediaReadyAndBuildElement(i,s){if(s.aborted)throw new DOMException('Cancelled before ensuring media readiness','AbortError');if(!i||i.isCoverFile)return null;if(!i.blobUrl&&i.loadSuccess!==!1){try{await loadBlobForItem(i,s)}catch(e){if(e.name==='AbortError')throw e}}if(s.aborted)throw new DOMException('Cancelled after trying to load blob','AbortError');return buildMediaElement(i)}
    async function displayMedia(m,s,l){if(s.aborted)return;if(!mediaContainerEl)return;mediaContainerEl.innerHTML='';mediaContainerEl.classList.remove('view-initial','view-filtered');mediaContainerEl.classList.add(l?'view-initial':'view-filtered');mediaContainerEl.style.display='block';const t=(m||[]).filter(i=>!i.isCoverFile);if(t.length===0){const e="text-align: center; width: 100%; column-span: all; padding: 20px 0;";if(!document.body.classList.contains('cover-active')){mediaContainerEl.innerHTML=`<p style="${e}">Nenhum item encontrado para exibir.</p>`}return}let a=[];const n=()=>a.forEach(clearTimeout);s.addEventListener('abort',n,{once:!0});const o=t.map(i=>ensureMediaReadyAndBuildElement(i,s)),r=(await Promise.allSettled(o)).filter(p=>p.status==='fulfilled'&&p.value).map(p=>p.value);if(!s.aborted&&r.length>0){const f=document.createDocumentFragment();r.forEach(e=>f.appendChild(e));mediaContainerEl.appendChild(f);r.forEach((e,d)=>{const p=setTimeout(()=>{if(!s.aborted&&e.isConnected){e.classList.add('visible')}},d*THUMB_ANIM_DELAY_STAGGER);a.push(p)})}else if(!s.aborted&&r.length===0&&t.length>0){const e="color:var(--error-text); text-align: center; width: 100%; column-span: all; padding: 20px 0;";mediaContainerEl.innerHTML=`<p style="${e}">Erro ao carregar itens de mídia.</p>`}s.removeEventListener('abort',n)}
    
    // Funções para Instagram Link
    function getInstagramUsername(fileName) {
        if (!fileName) return null;
        const match = fileName.match(/@([a-zA-Z0-9_.]+)/);
        return match ? match[1] : null;
    }

    function updateMainHeader(contentOrUsername) {
        if (!mainHeaderTitleEl) mainHeaderTitleEl = document.getElementById('main-header-title');
        if (!mainHeaderTitleEl) return;

        mainHeaderTitleEl.innerHTML = ''; 

        if (contentOrUsername && contentOrUsername.startsWith('@')) {
            const username = contentOrUsername.substring(1);
            const instagramLink = document.createElement('a');
            instagramLink.href = `https://www.instagram.com/${username}/`;
            instagramLink.textContent = 'Instagram';
            instagramLink.target = '_blank';
            instagramLink.rel = 'noopener noreferrer';
            instagramLink.classList.add('instagram-link');
            mainHeaderTitleEl.appendChild(instagramLink);
        } else {
            mainHeaderTitleEl.textContent = contentOrUsername || 'Random Media';
        }
    }

    async function displayFilteredMedia(p){if(!p||isLoading)return;if(searchInputEl&&searchInputEl.value)searchInputEl.value='';if(searchSuggestionsEl){searchSuggestionsEl.innerHTML='';searchSuggestionsEl.style.display='none'}const s=beginOperation();let c=null;let coverItemName = null; try{
        updateMainHeader('Random Media'); // Reset header
        resetLuckyFeature();if(speedDialContainerEl) speedDialContainerEl.style.display = 'none';
        hideCaminhoSidebar(); 
        clearTimeout(window.coverDisplayTimeoutId||0);if(coverOverlayBlur){coverOverlayBlur.classList.remove('visible');coverOverlayBlur.style.backgroundImage='none'}if(coverOverlay){coverOverlay.classList.remove('visible');coverOverlay.style.backgroundImage='none'}if(document.body)document.body.classList.remove('cover-active');if(loadingIndicatorEl){loadingIndicatorEl.textContent=`Filtrando por "${p}"...`;loadingIndicatorEl.style.display='block'}if(s.aborted)throw new DOMException('Cancelled early','AbortError');const e=mediaIndex.get(p.toLowerCase());if(!e||(!e.regulars?.length&&!e.covers?.length)){console.warn(`Prefix "${p}" not found in index.`);if(mediaContainerEl)mediaContainerEl.style.display='none';if(loadingIndicatorEl)loadingIndicatorEl.style.display='none';if(controlsContainerEl)controlsContainerEl.style.display='none';if(speedDialContainerEl)speedDialContainerEl.style.display='flex';document.body.classList.add('initial-load');activateLuckyFeature();setSpeedDialStatus(`Prefixo "${p}" não encontrado na pasta selecionada. Tente outro.`,!1);endOperation(!0);return}const o=e.covers||[];let r=e.regulars||[];if(r.length>MAX_FILTERED_ITEMS){r=getRandomMedia(r,MAX_FILTERED_ITEMS)}if(r.length===0){console.warn(`No regular media found for prefix "${p}", only covers or empty regulars list.`);if(coverOverlayBlur){coverOverlayBlur.classList.remove('visible');coverOverlayBlur.style.backgroundImage='none'}if(coverOverlay){coverOverlay.classList.remove('visible');coverOverlay.style.backgroundImage='none'}if(document.body)document.body.classList.remove('cover-active');if(mediaContainerEl){mediaContainerEl.innerHTML='';mediaContainerEl.style.display='none'}if(loadingIndicatorEl)loadingIndicatorEl.style.display='none';if(controlsContainerEl)controlsContainerEl.style.display='none';if(speedDialContainerEl)speedDialContainerEl.style.display='flex';document.body.classList.add('initial-load');activateLuckyFeature();setSpeedDialStatus(`Nenhum item regular encontrado para "${p}" neste Caminho. Selecione outro.`,!1);endOperation(!0);return}if(loadingIndicatorEl)loadingIndicatorEl.style.display='none';if(mediaContainerEl)mediaContainerEl.style.display='block';if(controlsContainerEl)controlsContainerEl.style.display='flex';document.body.classList.remove('initial-load');if(o.length>0){const u=o.filter(i=>i.loadSuccess!==!1);if(u.length>0){const t=u[Math.floor(Math.random()*u.length)];c=await loadCoverImageBlobUrl(t,s); coverItemName = t.name;}}
        
        if (coverItemName) { // Update header if cover is shown
            const username = getInstagramUsername(coverItemName);
            if (username) updateMainHeader('@' + username);
        }

        if(s.aborted)throw new DOMException('Cancelled during cover load','AbortError');if(c){if(coverOverlayBlur){coverOverlayBlur.style.backgroundImage=`url('${c}')`;requestAnimationFrame(()=>{if(!s.aborted)coverOverlayBlur.classList.add('visible')})}if(coverOverlay){coverOverlay.style.backgroundImage=`url('${c}')`;requestAnimationFrame(()=>{if(!s.aborted)coverOverlay.classList.add('visible')})}if(document.body&&!s.aborted)document.body.classList.add('cover-active');window.coverDisplayTimeoutId=setTimeout(async()=>{if(s.aborted)return;try{await displayMedia(r,s,!1);endOperation(!0)}catch(d){if(d.name!=='AbortError'){console.error("Error during post-cover media display:",d);setSpeedDialStatus(`Erro ao exibir mídia para "${p}" após a capa.`,!0)}endOperation(!1)}},COVER_DISPLAY_DELAY)}else{await displayMedia(r,s,!1);endOperation(!0)}}catch(e){if(e.name!=='AbortError'){console.error(`Error filtering for prefix "${p}":`,e);if(mediaContainerEl)mediaContainerEl.style.display='none';if(loadingIndicatorEl)loadingIndicatorEl.style.display='none';if(controlsContainerEl)controlsContainerEl.style.display='none';if(speedDialContainerEl)speedDialContainerEl.style.display='flex';document.body.classList.add('initial-load');activateLuckyFeature();setSpeedDialStatus(`Erro ao filtrar por "${p}". Verifique o console.`,!0);endOperation(!1)}else{console.log(`Filtering for "${p}" was cancelled.`);if(!isLoading){cleanupUIState();if(speedDialContainerEl)speedDialContainerEl.style.display='flex';if(controlsContainerEl)controlsContainerEl.style.display='none';if(document.body)document.body.classList.add('initial-load');activateLuckyFeature();setSpeedDialStatus(`Filtragem por "${p}" cancelada.`,!1);endOperation(!1)}}if(loadingIndicatorEl)loadingIndicatorEl.style.display='none';if(document.body&&!document.body.classList.contains('cover-active')){document.body.classList.remove('cover-active')}}}
    
    // Current signature: async function displayGlobalMediaByPrefix(t)
    // 't' is the prefixToSearch.
    async function displayGlobalMediaByPrefix(prefixToSearch) {
        if (!prefixToSearch || isLoading || !globalMediaIndex || globalMediaIndex.size === 0) { // Added check for globalMediaIndex
            if (!globalMediaIndex || globalMediaIndex.size === 0) {
                console.warn("displayGlobalMediaByPrefix called without a populated globalMediaIndex.");
                // Optionally set a status message for the user
            }
            return;
        }

        if (searchInputEl && searchInputEl.value) searchInputEl.value = '';
        if (searchSuggestionsEl) {
            searchSuggestionsEl.innerHTML = '';
            searchSuggestionsEl.style.display = 'none';
        }

        const s = beginOperation();
        let coverBlobUrl = null; // Renamed from 'g' for clarity
        let coverItemName = null;

        try {
            updateMainHeader('Random Media'); // Reset header
            resetLuckyFeature();
            if (speedDialContainerEl) speedDialContainerEl.style.display = 'none';
            
            // UI cleanup for media display area
            clearTimeout(window.coverDisplayTimeoutId || 0);
            if (coverOverlayBlur) {
                coverOverlayBlur.classList.remove('visible');
                coverOverlayBlur.style.backgroundImage = 'none';
            }
            if (coverOverlay) {
                coverOverlay.classList.remove('visible');
                coverOverlay.style.backgroundImage = 'none';
            }
            if (document.body) document.body.classList.remove('cover-active');
            
            if (loadingIndicatorEl) {
                loadingIndicatorEl.textContent = `Pesquisando por "${prefixToSearch}" em todos os Caminhos...`;
                loadingIndicatorEl.style.display = 'block';
            }

            if (s.aborted) throw new DOMException('Cancelled early (global search)', 'AbortError');

            const coverFileItems = []; // 'o' in original code
            const regularFileItems = []; // 'r' in original code
            const searchPrefixLower = prefixToSearch.toLowerCase();

            // Iterate through globalMediaIndex to find matching files
            for (const filesInCaminho of globalMediaIndex.values()) {
                if (s.aborted) throw new DOMException('Scan Cancelled during globalMediaIndex iteration (global search)', 'AbortError');
                for (const fileMeta of filesInCaminho) {
                    if (fileMeta.prefix && fileMeta.prefix.toLowerCase() === searchPrefixLower) {
                        // All necessary properties (name, fileRef, relativePath, isCoverFile, isOriginal, prefix)
                        // are already in fileMeta from when globalMediaIndex was built.
                        if (fileMeta.isCoverFile) {
                            coverFileItems.push(fileMeta);
                        } else {
                            regularFileItems.push(fileMeta);
                        }
                    }
                }
            }
            
            // The old loop iterating 'allSelectedFiles' and constructing 'M' objects is now replaced by the loop above.

            if (regularFileItems.length === 0 && coverFileItems.length === 0) {
                console.warn(`Prefix "${prefixToSearch}" not found anywhere.`);
                // ... (rest of the "not found" UI handling)
                if (mediaContainerEl) mediaContainerEl.style.display = 'none';
                if (loadingIndicatorEl) loadingIndicatorEl.style.display = 'none';
                if (controlsContainerEl) controlsContainerEl.style.display = 'none';
                if (speedDialContainerEl) speedDialContainerEl.style.display = 'flex';
                document.body.classList.add('initial-load');
                activateLuckyFeature();
                setSpeedDialStatus(`Prefixo "${prefixToSearch}" não encontrado em nenhum Caminho. Tente outro.`, false);
                endOperation(true);
                return;
            }

            let finalRegularItemsToDisplay = regularFileItems;
            if (finalRegularItemsToDisplay.length > MAX_FILTERED_ITEMS) {
                finalRegularItemsToDisplay = getRandomMedia(finalRegularItemsToDisplay, MAX_FILTERED_ITEMS);
            }

            if (finalRegularItemsToDisplay.length === 0) {
                console.warn(`No regular media found globally for prefix "${prefixToSearch}", only covers or empty regulars list.`);
                // ... (rest of the "no regular media" UI handling)
                if (coverOverlayBlur) { /* ... */ } // Ensure these are filled from original code as needed
                if (coverOverlay) { /* ... */ }
                if (document.body) document.body.classList.remove('cover-active');
                if (mediaContainerEl) {mediaContainerEl.innerHTML = ''; mediaContainerEl.style.display = 'none';}
                if (loadingIndicatorEl) loadingIndicatorEl.style.display = 'none';
                if (controlsContainerEl) controlsContainerEl.style.display = 'none';
                if (speedDialContainerEl) speedDialContainerEl.style.display = 'flex';
                document.body.classList.add('initial-load');
                activateLuckyFeature();
                setSpeedDialStatus(`Nenhum item regular encontrado para "${prefixToSearch}" em todos os Caminhos. Selecione outro.`, false);
                endOperation(true);
                return;
            }

            if (loadingIndicatorEl) loadingIndicatorEl.style.display = 'none';
            if (mediaContainerEl) mediaContainerEl.style.display = 'block';
            if (controlsContainerEl) controlsContainerEl.style.display = 'flex';
            document.body.classList.remove('initial-load');

            if (coverFileItems.length > 0) {
                const validCovers = coverFileItems.filter(i => i.loadSuccess !== false); // Prefer covers not known to have failed
                if (validCovers.length > 0) {
                    const selectedCoverMeta = validCovers[Math.floor(Math.random() * validCovers.length)];
                    // loadCoverImageBlobUrl expects an item with isCoverFile: true and fileRef
                    coverBlobUrl = await loadCoverImageBlobUrl(selectedCoverMeta, s); 
                    coverItemName = selectedCoverMeta.name;
                }
            }
            
            if (coverItemName) {
                const username = getInstagramUsername(coverItemName);
                if (username) updateMainHeader('@' + username);
            }

            if (s.aborted) throw new DOMException('Cancelled during global cover load', 'AbortError');

            if (coverBlobUrl) {
                // ... (rest of the cover display logic using coverBlobUrl)
                if (coverOverlayBlur) {coverOverlayBlur.style.backgroundImage=`url('${coverBlobUrl}')`;requestAnimationFrame(()=>{if(!s.aborted)coverOverlayBlur.classList.add('visible')})}
                if (coverOverlay) {coverOverlay.style.backgroundImage=`url('${coverBlobUrl}')`;requestAnimationFrame(()=>{if(!s.aborted)coverOverlay.classList.add('visible')})}
                if (document.body && !s.aborted) document.body.classList.add('cover-active');
                window.coverDisplayTimeoutId = setTimeout(async () => {
                    if (s.aborted) return;
                    try {
                        // displayMedia expects items with fileRef, type, blobUrl (if loaded), etc.
                        // The items in finalRegularItemsToDisplay are from globalMediaIndex and should be compatible.
                        await displayMedia(finalRegularItemsToDisplay, s, false);
                        endOperation(true);
                    } catch (d) {
                        if (d.name !== 'AbortError') {
                            console.error("Error during post-cover global media display:",d);
                            setSpeedDialStatus(`Erro ao exibir mídia global para "${prefixToSearch}" após a capa.`,true);
                        }
                        endOperation(false);
                    }
                }, COVER_DISPLAY_DELAY);
            } else {
                await displayMedia(finalRegularItemsToDisplay, s, false);
                endOperation(true);
            }
        } catch (e) {
            // ... (existing error handling logic)
            if (e.name !== 'AbortError') {
                console.error(`Error global filtering for prefix "${prefixToSearch}":`,e);
                if(mediaContainerEl)mediaContainerEl.style.display='none';
                if(loadingIndicatorEl)loadingIndicatorEl.style.display='none';
                if(controlsContainerEl)controlsContainerEl.style.display='none';
                if(speedDialContainerEl)speedDialContainerEl.style.display='flex';
                document.body.classList.add('initial-load');
                activateLuckyFeature();
                setSpeedDialStatus(`Erro ao filtrar globalmente por "${prefixToSearch}". Verifique o console.`,true);
                endOperation(false);
            } else {
                console.log(`Global filtering for "${prefixToSearch}" was cancelled.`);
                if(!isLoading){
                    cleanupUIState();
                    if(speedDialContainerEl)speedDialContainerEl.style.display='flex';
                    if(controlsContainerEl)controlsContainerEl.style.display='none';
                    if(document.body)document.body.classList.add('initial-load');
                    activateLuckyFeature();
                    setSpeedDialStatus(`Filtragem global por "${prefixToSearch}" cancelada.`,false);
                    endOperation(false)
                }
            }
            if (loadingIndicatorEl) loadingIndicatorEl.style.display = 'none';
            if (document.body && !document.body.classList.contains('cover-active')) {
                 document.body.classList.remove('cover-active');
            }
        }
    }
    function updateFullscreenTransform(){if(!fullscreenImgEl)return;fullscreenImgEl.style.transform=`translate(${imgOffsetX}px, ${imgOffsetY}px) rotate(${rotationAngle}deg) scale(${zoomScale})`}
    function showFullscreenMedia(s,t){if(!fullscreenMediaEl||!fullscreenImgEl||!fullscreenVideoEl||!rotateButtonEl)return;rotationAngle=0;zoomScale=1;imgOffsetX=0;imgOffsetY=0;isDragging=!1;fullscreenVideoEl.pause();fullscreenVideoEl.removeAttribute('src');if(fullscreenVideoEl.readyState>0){try{fullscreenVideoEl.load()}catch(e){}}fullscreenImgEl.removeAttribute('src');fullscreenImgEl.style.display='none';fullscreenVideoEl.style.display='none';fullscreenImgEl.removeEventListener('wheel',handleWheelZoom);fullscreenImgEl.removeEventListener('mousedown',handleMouseDownDrag);document.removeEventListener('mousemove',handleMouseMoveDrag);document.removeEventListener('mouseup',handleMouseUpDrag);fullscreenImgEl.onload=null;fullscreenImgEl.onerror=null;if(t?.startsWith('image')){fullscreenImgEl.style.display='block';rotateButtonEl.style.display='block';updateFullscreenTransform();fullscreenImgEl.onload=()=>{const c=fullscreenMediaEl.clientWidth*.9,h=fullscreenMediaEl.clientHeight*.9,i=fullscreenImgEl.naturalWidth/fullscreenImgEl.naturalHeight,r=c/h;let l;if(i>r){l=c/fullscreenImgEl.naturalWidth}else{l=h/fullscreenImgEl.naturalHeight}zoomScale=Math.min(l,1);fullscreenImgEl.style.width=`${fullscreenImgEl.naturalWidth*zoomScale}px`;fullscreenImgEl.style.height=`${fullscreenImgEl.naturalHeight*zoomScale}px`;imgOffsetX=0;imgOffsetY=0;updateFullscreenTransform();fullscreenImgEl.style.width='auto';fullscreenImgEl.style.height='auto';fullscreenImgEl.onload=null};fullscreenImgEl.onerror=()=>{console.error("Falha ao carregar imagem em tela cheia:",s);closeFullscreenMedia();fullscreenImgEl.onload=null;fullscreenImgEl.onerror=null};fullscreenImgEl.src=s;fullscreenImgEl.addEventListener('wheel',handleWheelZoom,{passive:!1});fullscreenImgEl.addEventListener('mousedown',handleMouseDownDrag)}else if(t?.startsWith('video')){fullscreenVideoEl.src=s;fullscreenVideoEl.style.display='block';rotateButtonEl.style.display='none';fullscreenVideoEl.play().catch(e=>console.warn("Autoplay bloqueado:",e))}else{console.warn("Tipo de mídia não suportado para fullscreen:",t);return}fullscreenMediaEl.style.display='flex'}
    function handleWheelZoom(e){e.preventDefault();e.stopPropagation();if(!fullscreenImgEl||fullscreenImgEl.style.display==='none')return;const r=fullscreenImgEl.getBoundingClientRect();if(r.width===0||r.height===0)return;const d=e.deltaY,s=d<0?ZOOM_SENSITIVITY:1/ZOOM_SENSITIVITY,o=zoomScale;let n=o*s;n=Math.max(MIN_ZOOM,Math.min(n,MAX_ZOOM));if(n===o)return;const m=e.clientX,y=e.clientY,cX=r.left+r.width/2,cY=r.top+r.height/2,pX_B=m-cX,pY_B=y-cY,pX_A=pX_B*(n/o),pY_A=pY_B*(n/o),dX=pX_B-pX_A,dY=pY_B-pY_A;imgOffsetX+=dX;imgOffsetY+=dY;zoomScale=n;requestAnimationFrame(updateFullscreenTransform)}
    function handleMouseDownDrag(e){e.preventDefault();e.stopPropagation();if(e.button!==0||!fullscreenImgEl||fullscreenImgEl.style.display==='none')return;isDragging=!0;dragStartX=e.clientX;dragStartY=e.clientY;dragStartOffsetX=imgOffsetX;dragStartOffsetY=imgOffsetY;fullscreenImgEl.classList.add('grabbing');fullscreenImgEl.style.transition='none';document.addEventListener('mousemove',handleMouseMoveDrag);document.addEventListener('mouseup',handleMouseUpDrag)}
    function handleMouseMoveDrag(e){if(!isDragging)return;e.preventDefault();e.stopPropagation();const cX=e.clientX,cY=e.clientY,dX=cX-dragStartX,dY=cY-dragStartY;imgOffsetX=dragStartOffsetX+dX;imgOffsetY=dragStartOffsetY+dY;requestAnimationFrame(updateFullscreenTransform)}
    function handleMouseUpDrag(e){if(!isDragging||e.button!==0)return;e.preventDefault();e.stopPropagation();isDragging=!1;fullscreenImgEl.classList.remove('grabbing');fullscreenImgEl.style.transition='';document.removeEventListener('mousemove',handleMouseMoveDrag);document.removeEventListener('mouseup',handleMouseUpDrag)}
    function rotateImage(e){e.stopPropagation();if(!fullscreenImgEl||isDragging)return;const rB=fullscreenImgEl.getBoundingClientRect(),cXB=rB.left+rB.width/2,cYB=rB.top+rB.height/2;rotationAngle=(rotationAngle+90)%360;updateFullscreenTransform();requestAnimationFrame(()=>{const rA=fullscreenImgEl.getBoundingClientRect(),cXA=rA.left+rA.width/2,cYA=rA.top+rA.height/2,dX=cXB-cXA,dY=cYB-cYA;imgOffsetX+=dX;imgOffsetY+=dY;updateFullscreenTransform()})}
    function closeFullscreenMedia(){if(!fullscreenMediaEl||!fullscreenVideoEl||!fullscreenImgEl)return;fullscreenMediaEl.style.display='none';fullscreenVideoEl.pause();fullscreenVideoEl.removeAttribute('src');if(fullscreenVideoEl.readyState>0){try{fullscreenVideoEl.load()}catch(e){console.warn("Error trying to unload video:",e)}}fullscreenImgEl.removeAttribute('src');fullscreenImgEl.onload=null;fullscreenImgEl.onerror=null;fullscreenImgEl.style.transform='none';fullscreenImgEl.style.width='auto';fullscreenImgEl.style.height='auto';fullscreenImgEl.removeEventListener('wheel',handleWheelZoom);fullscreenImgEl.removeEventListener('mousedown',handleMouseDownDrag);document.removeEventListener('mousemove',handleMouseMoveDrag);document.removeEventListener('mouseup',handleMouseUpDrag);isDragging=!1;fullscreenImgEl.classList.remove('grabbing');fullscreenImgEl.style.display='none'}
    function getIconBaseName(o){const m=o.match(/\d+$/);return m?`icon${m[0]}`:`icon_${o.replace(/[^a-z0-9]/gi,'_')}`}
    function findFileByPath(f,r){if(!f)return null;const n=r.replace(/^\.\//,'');for(const i of f){const p=i.webkitRelativePath?.replace(/^\.\//,'');if(p===n){return i}}return null}
    function revokeGeneratedBlobUrls(){let c=0;for(const u of iconBlobUrls.values()){if(u){try{URL.revokeObjectURL(u);c++}catch(e){}}}iconBlobUrls.clear();if(faviconBlobUrl){try{URL.revokeObjectURL(faviconBlobUrl)}catch(e){}}faviconBlobUrl=null;if(faviconElement)faviconElement.href='#'}
    function resetSpeedDialIcons(){revokeGeneratedBlobUrls();if(speedDialOptionsEl){speedDialOptionsEl.querySelectorAll('.speed-dial-item').forEach(i=>{i.classList.remove('icon-error');const m=i.querySelector('img.speed-dial-icon');if(m){m.src='';m.classList.remove('loaded')}})}}
    function resetFavicon(){if(faviconBlobUrl){try{URL.revokeObjectURL(faviconBlobUrl)}catch(e){}}faviconBlobUrl=null;if(faviconElement)faviconElement.href='#'}
    async function loadSpecificIcons(filesFromInput) { // filesFromInput is allSelectedFiles, can be removed if not used otherwise
        if (!speedDialOptionsEl) return;
        let iconsFoundThisRun = false;

        const capasFiles = globalMediaIndex.get('_CAPAS_') || [];

        const iconLoadPromises = speedDialConfig.map(async config => {
            const speedDialItemEl = speedDialOptionsEl.querySelector(`.speed-dial-item[data-caminho="${config.originalName}"]`);
            if (!speedDialItemEl) return;

            const iconBaseName = getIconBaseName(config.originalName);
            // No rootDirName prefix needed for lookup in _CAPAS_ as paths are already full
            const avifPath = `${rootDirName ? rootDirName + '/' : ''}${CAPAS_FOLDER_NAME}/${iconBaseName}.avif`;
            const jpgPath = `${rootDirName ? rootDirName + '/' : ''}${CAPAS_FOLDER_NAME}/${iconBaseName}.jpg`;
            const pngPath = `${rootDirName ? rootDirName + '/' : ''}${CAPAS_FOLDER_NAME}/${iconBaseName}.png`;
            
            let iconFileMetadata = capasFiles.find(meta => 
                meta.relativePath === avifPath || 
                meta.relativePath === jpgPath ||
                meta.relativePath === pngPath
            );

            const imgEl = speedDialItemEl.querySelector('img.speed-dial-icon');
            if (iconFileMetadata && imgEl) {
                try {
                    const oldBlobUrl = iconBlobUrls.get(config.originalName);
                    if (oldBlobUrl) {
                        try { URL.revokeObjectURL(oldBlobUrl); } catch (e) { /*ignore*/ }
                    }
                    
                    // Ensure fileRef is a File object before creating blob
                    if (!(iconFileMetadata.fileRef instanceof File)) {
                        console.error('Icon fileRef is not a File object for:', iconFileMetadata.name);
                        throw new Error('Invalid file reference for icon.');
                    }

                    const newBlobUrl = URL.createObjectURL(iconFileMetadata.fileRef);
                    iconBlobUrls.set(config.originalName, newBlobUrl);
                    imgEl.src = newBlobUrl;
                    imgEl.alt = `Ícone para ${config.displayName}`;
                    imgEl.onload = () => imgEl.classList.add('loaded');
                    imgEl.onerror = () => {
                        speedDialItemEl.classList.add('icon-error');
                        URL.revokeObjectURL(newBlobUrl);
                        iconBlobUrls.delete(config.originalName);
                        console.error(`Failed to load icon image: ${iconFileMetadata?.name}`);
                    };
                    speedDialItemEl.classList.remove('icon-error');
                    iconsFoundThisRun = true;
                } catch (error) {
                    speedDialItemEl.classList.add('icon-error');
                    if (imgEl) imgEl.src = '';
                    console.error("Error creating blob for icon:", config.originalName, error);
                }
            } else {
                speedDialItemEl.classList.add('icon-error');
                if (imgEl) imgEl.src = '';
            }
        });

        await Promise.allSettled(iconLoadPromises);

        const statusMessage = `Pasta "${rootDirName}" carregada (${allSelectedFiles?.length || 0} arquivos). Escolha um Caminho:`;
        setSpeedDialStatus(statusMessage);
    }
    async function loadSpecificFavicon(filesFromInput) { // filesFromInput is allSelectedFiles, can be removed
        if (!faviconElement) return;

        const capasFiles = globalMediaIndex.get('_CAPAS_') || [];
        // No rootDirName prefix needed for lookup in _CAPAS_
        const favAvifPath = `${rootDirName ? rootDirName + '/' : ''}${CAPAS_FOLDER_NAME}/fav.avif`;
        const favJpgPath = `${rootDirName ? rootDirName + '/' : ''}${CAPAS_FOLDER_NAME}/fav.jpg`;

        let faviconFileMetadata = capasFiles.find(meta => 
            meta.relativePath === favAvifPath || meta.relativePath === favJpgPath
        );

        resetFavicon(); // Revokes old faviconBlobUrl

        if (faviconFileMetadata) {
            try {
                 // Ensure fileRef is a File object
                if (!(faviconFileMetadata.fileRef instanceof File)) {
                    console.error('Favicon fileRef is not a File object for:', faviconFileMetadata.name);
                    throw new Error('Invalid file reference for favicon.');
                }
                faviconBlobUrl = URL.createObjectURL(faviconFileMetadata.fileRef);
                faviconElement.href = faviconBlobUrl;
            } catch (error) {
                console.error("Error creating blob URL for favicon:", error);
                resetFavicon(); // Ensure it's reset on error
            }
        }
    }
    
    function getLuckyCoverCandidates() {
        // Retrieve cover file metadata directly from globalMediaIndex
        const capasFilesMetadata = globalMediaIndex.get('_CAPAS_') || [];
        if (capasFilesMetadata.length === 0) return [];

        const candidates = [];
        for (const fileMeta of capasFilesMetadata) {
            // The fileMeta object already contains:
            // fileMeta.name (fileName)
            // fileMeta.relativePath
            // fileMeta.prefix
            // fileMeta.fileRef
            // fileMeta.isCoverFile (should be true for _CAPAS_ items)

            // Apply the same filtering logic as before
            if (isImageFile(fileMeta.name) && !ICON_NAME_REGEX.test(fileMeta.name)) {
                candidates.push({
                    fileRef: fileMeta.fileRef, // Pass the actual File object
                    prefix: fileMeta.prefix,
                    name: fileMeta.name,
                    relativePath: fileMeta.relativePath
                    // No need to re-calculate isCoverFile, it's inherently a cover if from _CAPAS_
                    // and not an icon.
                });
            }
        }
        return candidates;
    }

    function resetLuckyFeature() {
        if (luckyImageBlobUrl) {
            try { URL.revokeObjectURL(luckyImageBlobUrl); } catch (e) { console.warn("Error revoking lucky blob", e); }
            luckyImageBlobUrl = null;
        }
        currentLuckyFileItem = null;
        if (luckyImageEl) luckyImageEl.src = "#";
        if (luckyImageTextEl) {
            luckyImageTextEl.textContent = '';
            luckyImageTextEl.style.display = 'none';
        }
        if (luckyImageWrapperEl) {
            luckyImageWrapperEl.style.display = 'none';
        }
        if (luckyFeatureContainerEl) {
             luckyFeatureContainerEl.style.display = 'none';
        }
        if (speedDialContainerEl) {
            speedDialContainerEl.style.removeProperty('--speed-dial-background-image-url');
        }
        luckyFeatureState = 'initial';
    }

    async function activateLuckyFeature() {
        if (isLoading || !allSelectedFiles || !speedDialContainerEl || speedDialContainerEl.style.display === 'none') {
            resetLuckyFeature();
            return;
        }
        resetLuckyFeature(); 
        const s = currentOperationController ? currentOperationController.signal : null;

        try {
            const candidates = getLuckyCoverCandidates();
            if (candidates.length === 0) {
                if(luckyFeatureContainerEl) luckyFeatureContainerEl.style.display = 'none';
                return;
            }

            const luckyFile = candidates[Math.floor(Math.random() * candidates.length)];
            currentLuckyFileItem = {
                name: luckyFile.name,
                fileRef: luckyFile.fileRef,
                relativePath: luckyFile.relativePath,
                isCoverFile: true, 
                isOriginal: false, 
                prefix: luckyFile.prefix,
                blobUrl: null, type: null, loadSuccess: null, abortController: null
            };
            
            const blobLoaded = await loadBlobForItem(currentLuckyFileItem, s);
            if (s?.aborted) throw new DOMException("Lucky feature cancelled during blob load", "AbortError");

            if (blobLoaded && currentLuckyFileItem.blobUrl) {
                luckyImageBlobUrl = currentLuckyFileItem.blobUrl;
                if(luckyImageEl) {
                    luckyImageEl.src = luckyImageBlobUrl;
                    luckyImageEl.alt = `Capa da sorte: ${currentLuckyFileItem.prefix}`;
                }
                if(luckyImageWrapperEl) {
                    luckyImageWrapperEl.style.display = 'block';
                }
                if(luckyImageTextEl) luckyImageTextEl.style.display = 'none';
                if(luckyFeatureContainerEl) luckyFeatureContainerEl.style.display = 'block';
                
                if (speedDialContainerEl && luckyImageBlobUrl) {
                    speedDialContainerEl.style.setProperty('--speed-dial-background-image-url', `url('${luckyImageBlobUrl}')`);
                }
                luckyFeatureState = 'image_ready';
            } else {
                console.warn("Failed to load blob for lucky image, or operation aborted.");
                resetLuckyFeature(); 
            }
        } catch (e) {
            if (e.name !== 'AbortError') {
                console.error("Error in activateLuckyFeature:", e);
                setSpeedDialStatus(`Erro ao mostrar imagem da sorte: ${e.message || 'Erro desconhecido'}`, true);
            }
            resetLuckyFeature();
        }
    }

    async function handleLuckyImageClick() {
        if (isLoading || !currentLuckyFileItem || !luckyImageWrapperEl) return;

        if (luckyFeatureState === 'image_ready') {
            if (luckyImageTextEl) {
                luckyImageTextEl.textContent = `Explore mais de "${currentLuckyFileItem.prefix}"`;
                luckyImageTextEl.style.display = 'block';
            }
            luckyFeatureState = 'explore_ready';
        } else if (luckyFeatureState === 'explore_ready' && currentLuckyFileItem.prefix) {
            if(speedDialContainerEl) speedDialContainerEl.style.display = 'none';
            document.body.classList.remove('initial-load');
            hideCaminhoSidebar(); 
            await displayGlobalMediaByPrefix(currentLuckyFileItem.prefix);
        }
    }

    function showCaminhoSidebar(caminhoName, items) {
        if (!caminhoSidebarEl || !caminhoSidebarListEl || !caminhoSidebarTitleEl) return;
        
        const speedDialEntry = speedDialConfig.find(cfg => cfg.originalName === caminhoName);
        const displayName = speedDialEntry ? speedDialEntry.displayName : caminhoName;

        caminhoSidebarTitleEl.textContent = `Navegar em "${displayName}"`;
        caminhoSidebarListEl.innerHTML = ''; 

        if (items.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'Nenhum nome único encontrado.';
            li.style.cursor = 'default';
            caminhoSidebarListEl.appendChild(li);
        } else {
            items.forEach(itemPrefix => {
                const li = document.createElement('li');
                li.textContent = itemPrefix;
                li.title = `Pesquisar por "${itemPrefix}"`;
                li.addEventListener('click', () => {
                    if (!isLoading) {
                        displayGlobalMediaByPrefix(itemPrefix);
                    }
                });
                caminhoSidebarListEl.appendChild(li);
            });
        }
        caminhoSidebarEl.classList.add('visible');
        document.body.classList.add('sidebar-active');
    }

    function hideCaminhoSidebar() {
        if (caminhoSidebarEl) {
            caminhoSidebarEl.classList.remove('visible');
        }
        document.body.classList.remove('sidebar-active');
    }


    // Current signature: async function processAndDisplayFilesForPath(f, t)
    // 'f' is allSelectedFiles, 't' is selectedCaminhoName.
    // We aim to reduce or eliminate the need for 'f'.
    async function processAndDisplayFilesForPath(allFilesList, selectedCaminhoName) {
        // allFilesList might not be needed if globalMediaIndex is solely used.
        // For now, let's assume it might be used by parts of the code not yet refactored.
        // If not, it can be removed from the signature.

        if (!globalMediaIndex || globalMediaIndex.size === 0) { // Check if globalMediaIndex is populated
            setSpeedDialStatus("Erro interno: Índice global de arquivos não disponível. Selecione a pasta 'Nucleo' novamente.", true);
            console.error("processAndDisplayFilesForPath called without a populated globalMediaIndex.");
            // Potentially call endOperation() or reset UI here if needed.
            return;
        }

        const s = beginOperation();
        resetLuckyFeature();
        try {
            updateMainHeader('Random Media'); // Reset header
            if (speedDialContainerEl) speedDialContainerEl.style.display = 'none';
            document.body.classList.remove('initial-load');
            cleanupUIState(); // Clears mediaContainerEl, loadingIndicatorEl, etc.
            
            // Revoke resources from previous mediaFiles list
            mediaFiles.forEach(revokeItemResources);
            mediaFiles = []; // Clear the current mediaFiles array
            // mediaIndex.clear(); // buildMediaIndex will clear and rebuild this

            initialViewHistory = []; // Reset history for the new path
            sessionViewedPrefixes.clear(); // Reset session prefixes

            if (loadingIndicatorEl) {
                loadingIndicatorEl.textContent = `Processando "${selectedCaminhoName}"...`;
                loadingIndicatorEl.style.display = 'block';
            }

            // Get files for the selected Caminho directly from globalMediaIndex
            const caminhoSpecificFiles = globalMediaIndex.get(selectedCaminhoName) || [];
            // Get all cover files from globalMediaIndex
            const coverFiles = globalMediaIndex.get('_CAPAS_') || [];

            // Combine them into the new mediaFiles list for this path.
            // The objects in globalMediaIndex should already have the correct structure.
            mediaFiles = [...caminhoSpecificFiles, ...coverFiles];

            if (s.aborted) throw new DOMException('Scan Cancelled during file preparation', 'AbortError');

            if (mediaFiles.length > 0) {
                if (loadingIndicatorEl) loadingIndicatorEl.textContent = `Indexando ${mediaFiles.length} itens para "${selectedCaminhoName}"...`;
                
                // buildMediaIndex will operate on the new, smaller mediaFiles list
                buildMediaIndex(s); 
                if (s.aborted) throw new DOMException('Indexing Cancelled for Caminho', 'AbortError');

                const regularMediaInPath = mediaFiles.filter(i => !i.isCoverFile && i.caminhoName === selectedCaminhoName);

                if (loadingIndicatorEl) loadingIndicatorEl.style.display = 'none';

                if (regularMediaInPath.length > 0) {
                    if (controlsContainerEl) controlsContainerEl.style.display = 'flex';
                    // getRandomInitialMedia will also operate on the smaller regularMediaInPath
                    await displayMedia(getRandomInitialMedia(regularMediaInPath, MAX_INITIAL_ITEMS), s, true);
                    
                    const uniquePrefixesInPath = Array.from(new Set(regularMediaInPath.map(file => file.prefix).filter(Boolean))).sort((a, b) => a.localeCompare(b));
                    showCaminhoSidebar(selectedCaminhoName, uniquePrefixesInPath);
                } else {
                    // No regular media found in this specific Caminho
                    if (mediaContainerEl) mediaContainerEl.style.display = 'none';
                    if (controlsContainerEl) controlsContainerEl.style.display = 'none';
                    if (speedDialContainerEl) speedDialContainerEl.style.display = 'flex';
                    document.body.classList.add('initial-load');
                    activateLuckyFeature();
                    setSpeedDialStatus(`"${selectedCaminhoName}" não contém arquivos de mídia regulares. Selecione outro.`, false);
                    hideCaminhoSidebar();
                    endOperation(true);
                    return;
                }
            } else {
                // No files at all (neither regular nor covers related to this selection logic)
                if (loadingIndicatorEl) loadingIndicatorEl.style.display = 'none';
                if (mediaContainerEl) mediaContainerEl.style.display = 'none';
                if (controlsContainerEl) controlsContainerEl.style.display = 'none';
                if (speedDialContainerEl) speedDialContainerEl.style.display = 'flex';
                document.body.classList.add('initial-load');
                activateLuckyFeature();
                setSpeedDialStatus(`Nenhum arquivo de mídia relevante encontrado para "${selectedCaminhoName}". Selecione outro.`, true);
                hideCaminhoSidebar();
                endOperation(true);
                return;
            }
            endOperation(true);
        } catch (e) {
            if (e.name !== 'AbortError') {
                console.error(`Error processing path "${selectedCaminhoName}":`, e);
            }
            cleanupUIState();
            if (mediaContainerEl) mediaContainerEl.style.display = 'none';
            if (controlsContainerEl) controlsContainerEl.style.display = 'none';
            if (speedDialContainerEl) speedDialContainerEl.style.display = 'flex';
            document.body.classList.add('initial-load');
            if (loadingIndicatorEl) loadingIndicatorEl.style.display = 'none';
            const m = e.name === 'AbortError' ? `Operação cancelada ao processar "${selectedCaminhoName}".` : `Erro ao processar "${selectedCaminhoName}": ${e.message || 'Erro desconhecido'}.`;
            activateLuckyFeature();
            setSpeedDialStatus(m, e.name !== 'AbortError');
            // resetSpeedDialIcons(); // Icons are global, not path specific for loading
            // resetFavicon(); // Favicon is global
            hideCaminhoSidebar();
            endOperation(false);
        }
    }
    function handleSearchInput() {
        if (!searchInputEl || !searchSuggestionsEl || !mediaIndex) return;

        // Abort any pending thumbnail loading from previous input
        if (suggestionAbortController) {
            suggestionAbortController.abort();
        }
        suggestionAbortController = new AbortController();
        const currentSearchSignal = suggestionAbortController.signal;

        const t = searchInputEl.value.trim().toLowerCase();
        searchSuggestionsEl.innerHTML = '';
        if (t.length === 0) {
            searchSuggestionsEl.style.display = 'none';
            return;
        }

        const n = new Map(); // Using 'n' as in original code (Map of prefix to coverFileMeta)
        for (const e of mediaIndex.keys()) { // e is a prefix string from current Caminho's mediaIndex
            if (e.startsWith(t) && !/^icon(\s*\d*)?$/i.test(e)) { // Exclude icon-like prefixes
                const i = mediaIndex.get(e); // i is {covers: [], regulars: []}
                if (i && i.covers && i.covers.length > 0) {
                    const o = i.covers[0]; // o is a fileMeta object for one cover
                    if (o && o.prefix) { // Ensure prefix exists on the cover object
                        if (!n.has(o.prefix)) {
                            n.set(o.prefix, o); // Store the cover fileMeta object
                            if (n.size >= MAX_SEARCH_SUGGESTIONS) break;
                        }
                    }
                }
            }
        }

        if (n.size > 0) {
            const s_sortedPrefixes = Array.from(n.keys()).sort((a, b) => a.localeCompare(b)); // s_sortedPrefixes is sorted array of prefixes
            const c_fragment = document.createDocumentFragment(); // c_fragment is document fragment
            for (const e_prefix of s_sortedPrefixes) { // e_prefix is a prefix string
                const i_coverFileMeta = n.get(e_prefix); // i_coverFileMeta is the coverFileMeta object
                const o_suggestionItemDiv = document.createElement('div'); // o_suggestionItemDiv is suggestion item div
                o_suggestionItemDiv.className = 'suggestion-item';
                o_suggestionItemDiv.title = `Mostrar mídia para "${e_prefix}"`;
                o_suggestionItemDiv.setAttribute('role', 'option');
                o_suggestionItemDiv.tabIndex = -1;
                const l_thumbnailImg = document.createElement('img'); // l_thumbnailImg is thumbnail img
                l_thumbnailImg.className = 'suggestion-thumbnail';
                l_thumbnailImg.alt = `Capa para ${e_prefix}`;
                o_suggestionItemDiv.appendChild(l_thumbnailImg);

                // Async load thumbnail, passing the currentSearchSignal
                (async () => {
                    try {
                        if (currentSearchSignal.aborted) return; // Check before starting
                        if (i_coverFileMeta) { 
                            if (!i_coverFileMeta.blobUrl || i_coverFileMeta.loadSuccess !== true) {
                                // Pass currentSearchSignal to loadBlobForItem
                                await loadBlobForItem(i_coverFileMeta, currentSearchSignal);
                            }
                            if (currentSearchSignal.aborted) return; // Check after await
                            
                            if (i_coverFileMeta.blobUrl && i_coverFileMeta.loadSuccess === true) {
                                l_thumbnailImg.src = i_coverFileMeta.blobUrl;
                                l_thumbnailImg.onload = () => { if (!currentSearchSignal.aborted) l_thumbnailImg.classList.add('loaded'); };
                                l_thumbnailImg.onerror = () => { if (!currentSearchSignal.aborted) l_thumbnailImg.style.display = 'none'; console.warn(`Error rendering suggestion thumbnail for ${e_prefix}`); };
                            } else {
                                if (!currentSearchSignal.aborted) l_thumbnailImg.style.display = 'none';
                            }
                        } else {
                            if (!currentSearchSignal.aborted) l_thumbnailImg.style.display = 'none';
                        }
                    } catch (a) {
                        if (a.name !== 'AbortError') {
                            console.warn(`Error in async load for suggestion thumbnail ${e_prefix}:`, a);
                            if (!currentSearchSignal.aborted) l_thumbnailImg.style.display = 'none';
                        }
                    }
                })();

                const r_textSpan = document.createElement('span'); // r_textSpan is suggestion text span
                r_textSpan.className = 'suggestion-text';
                r_textSpan.textContent = e_prefix;
                o_suggestionItemDiv.appendChild(r_textSpan);
                o_suggestionItemDiv.addEventListener('mousedown', evt => { evt.preventDefault(); handleSuggestionClick(e_prefix); });
                o_suggestionItemDiv.addEventListener('keydown', evt => { if (evt.key === 'Enter') handleSuggestionClick(e_prefix); });
                c_fragment.appendChild(o_suggestionItemDiv);
            }
            searchSuggestionsEl.appendChild(c_fragment);
            searchSuggestionsEl.style.display = 'block';
        } else {
            searchSuggestionsEl.style.display = 'none';
        }
    }

    function handleSuggestionClick(p) {
        if (suggestionAbortController) {
            suggestionAbortController.abort(); // Cancel pending thumbnail loads
            suggestionAbortController = null;
        }
        if (!searchInputEl || !searchSuggestionsEl || isLoading) return;
        searchSuggestionsEl.innerHTML='';
        searchSuggestionsEl.style.display='none';
        resetLuckyFeature(); 
        if (speedDialContainerEl) speedDialContainerEl.style.display = 'none'; 
        document.body.classList.remove('initial-load'); 
        hideCaminhoSidebar(); 
        displayGlobalMediaByPrefix(p);
    }

    function hideSuggestionsOnClickOutside(e) {
        if (!searchInputEl || !searchSuggestionsEl) return;
        if (!e.target.closest('.search-container') && !e.target.closest('#search-suggestions')) {
            if (searchSuggestionsEl.innerHTML !== '') { // Only abort if there were suggestions
                 if (suggestionAbortController) {
                    suggestionAbortController.abort();
                    suggestionAbortController = null;
                }
            }
            searchSuggestionsEl.innerHTML = '';
            searchSuggestionsEl.style.display = 'none';
        }
    }
    function loadSpeedDialConfig(){try{const s=localStorage.getItem(SPEED_DIAL_CONFIG_KEY);if(s){const p=JSON.parse(s);if(Array.isArray(p)&&p.every(i=>i&&typeof i.originalName==='string'&&typeof i.displayName==='string')){const c=new Set(p.map(i=>i.originalName)),d=new Set(CAMINHO_FOLDER_NAMES);if(c.size===d.size&&[...c].every(n=>d.has(n))){speedDialConfig=p;return}else{console.warn("Speed dial config mismatch with defaults. Resetting.");throw new Error("Config mismatch")}}else{console.warn("Invalid speed dial config found in localStorage. Resetting.")}}}catch(e){console.error("Failed to load or parse speed dial config. Resetting to default.",e)}speedDialConfig=CAMINHO_FOLDER_NAMES.map(n=>({originalName:n,displayName:n}));saveSpeedDialConfig()}
    function saveSpeedDialConfig(){try{localStorage.setItem(SPEED_DIAL_CONFIG_KEY,JSON.stringify(speedDialConfig))}catch(e){console.error("Failed to save speed dial config to localStorage:",e);setSpeedDialStatus("Não foi possível salvar a ordem/nomes dos itens.",!0)}}
    async function handleCaminhoSelection(e){const t=e.target.closest('.speed-dial-item');if(isLoading||!allSelectedFiles||!t){if(!allSelectedFiles&&!isLoading)setSpeedDialStatus("Selecione a pasta 'Nucleo' primeiro.",!0);return}const o=t.dataset.caminho;if(!o){console.error("Clicked speed dial item missing 'data-caminho' attribute.",t);setSpeedDialStatus("Erro ao identificar o caminho selecionado.",!0);return}resetLuckyFeature(); await processAndDisplayFilesForPath(allSelectedFiles,o)}
    function renderSpeedDialItems(){if(!speedDialOptionsEl)return;speedDialOptionsEl.innerHTML='';const f=document.createDocumentFragment();speedDialConfig.forEach(c=>{const i=document.createElement('div');i.className='speed-dial-item';i.dataset.caminho=c.originalName;i.setAttribute('role','button');i.setAttribute('tabindex','0');i.draggable=!0;const o=document.createElement('div');o.className='icon-container';const m=document.createElement('img');m.className='speed-dial-icon';m.alt=`Ícone para ${c.displayName}`;m.src="";m.loading='lazy';const u=iconBlobUrls.get(c.originalName);if(u){m.src=u;m.classList.add('loaded')}else{i.classList.remove('icon-error')}o.appendChild(m);i.appendChild(o);const textEl=document.createElement('span');textEl.className='text';textEl.textContent=c.displayName;i.appendChild(textEl);const e=document.createElement('button');e.className='edit-btn';e.innerHTML='✎';e.title=`Renomear ${c.displayName}`;e.setAttribute('aria-label',`Renomear ${c.displayName}`);e.onclick=b=>{b.stopPropagation();b.preventDefault();handleRenameItem(c.originalName)};i.appendChild(e);i.addEventListener('click',handleCaminhoSelection);i.addEventListener('keydown',b=>{if(b.key==='Enter'||b.key===' '){b.preventDefault();handleCaminhoSelection(b)}});i.addEventListener('dragstart',handleDragStart);i.addEventListener('dragover',handleDragOver);i.addEventListener('dragleave',handleDragLeave);i.addEventListener('drop',handleDrop);i.addEventListener('dragend',handleDragEnd);f.appendChild(i)});speedDialOptionsEl.appendChild(f)}
    function handleRenameItem(o){const i=speedDialConfig.findIndex(t=>t.originalName===o);if(i===-1)return;const c=speedDialConfig[i].displayName,n=prompt(`Digite o novo nome para "${c}" (original: ${o}):`,c);if(n&&n.trim()!==''&&n.trim()!==c){speedDialConfig[i].displayName=n.trim();saveSpeedDialConfig();renderSpeedDialItems();setSpeedDialStatus(`"${c}" renomeado para "${n}".`,!1)}else if(n===null){setSpeedDialStatus("Renomeação cancelada.",!1)}else{setSpeedDialStatus("Nome inválido ou inalterado.",!0)}}
    function handleDragStart(e){const i=e.target.closest('.speed-dial-item');if(!i)return;draggedItemOriginalName=i.dataset.caminho;e.dataTransfer.setData('text/plain',draggedItemOriginalName);e.dataTransfer.effectAllowed='move';setTimeout(()=>i.classList.add('dragging'),0)}
    function handleDragOver(e){e.preventDefault();e.dataTransfer.dropEffect='move';const t=e.target.closest('.speed-dial-item');if(t&&t.dataset.caminho!==draggedItemOriginalName){t.classList.add('drag-over')}}
    function handleDragLeave(e){const t=e.target.closest('.speed-dial-item');if(t){t.classList.remove('drag-over')}}
    function handleDrop(e){e.preventDefault();const t=e.target.closest('.speed-dial-item');if(!t||t.dataset.caminho===draggedItemOriginalName||!draggedItemOriginalName){if(t)t.classList.remove('drag-over');return}const o=t.dataset.caminho;t.classList.remove('drag-over');const d=speedDialConfig.findIndex(i=>i.originalName===draggedItemOriginalName),g=speedDialConfig.findIndex(i=>i.originalName===o);if(d!==-1&&g!==-1){const[r]=speedDialConfig.splice(d,1);speedDialConfig.splice(g,0,r);saveSpeedDialConfig();renderSpeedDialItems();setSpeedDialStatus("Ordem atualizada.",!1)}draggedItemOriginalName=null}
    function handleDragEnd(e){const i=e.target.closest('.speed-dial-item');if(i){i.classList.remove('dragging')}document.querySelectorAll('.speed-dial-item.drag-over').forEach(el=>el.classList.remove('drag-over'));draggedItemOriginalName=null}
    async function handleFolderSelection(e) {
        const currentOperationSignal = beginOperation(); 
        const f = e.target.files;
        const i = e.target; // folderInputEl
    
        if (!f || f.length === 0) {
            setSpeedDialStatus("Nenhuma pasta selecionada ou seleção cancelada.", false);
            allSelectedFiles = null;
            rootDirName = '';
            if (selectNucleoButtonEl) selectNucleoButtonEl.style.display = 'inline-block';
            if (speedDialOptionsEl) speedDialOptionsEl.style.display = 'none';
            resetSpeedDialIcons();
            resetFavicon();
            resetLuckyFeature();
            document.body.classList.add('initial-load');
            if (controlsContainerEl) controlsContainerEl.style.display = 'none';
            if (i) i.value = null;
            hideCaminhoSidebar();
            updateMainHeader('Random Media');
            endOperation(true); 
            return;
        }
    
        let r = "Seleção";
        if (f[0]?.webkitRelativePath) {
            const F_firstPath = f[0].webkitRelativePath.replace(/^\.\//, '');
            const s_firstRoot = F_firstPath.split('/')[0];
            if (s_firstRoot) {
                r = s_firstRoot;
                // No need to check all paths for consistency here, rootDirName is determined and used.
            }
        }
        rootDirName = r;
    
        allSelectedFiles = f; 
        globalMediaIndex.clear();
        mediaFiles.forEach(revokeItemResources); 
        mediaFiles = [];
        mediaIndex.clear(); 
        initialViewHistory = [];
        sessionViewedPrefixes.clear();
        
        cleanupUIState(); 
        resetSpeedDialIcons();
        resetFavicon();
        resetLuckyFeature();
        updateMainHeader('Random Media');
        if (controlsContainerEl) controlsContainerEl.style.display = 'none';
        if (selectNucleoButtonEl) selectNucleoButtonEl.style.display = 'none';
        if (document.getElementById('speed-dial-subtitle')) document.getElementById('speed-dial-subtitle').style.display = 'none';
        if (speedDialOptionsEl) speedDialOptionsEl.style.display = 'grid'; 
        
        document.body.classList.add('initial-load');
        if (speedDialOptionsEl) {
            speedDialOptionsEl.querySelectorAll('.speed-dial-item').forEach(t => {
                t.style.pointerEvents = 'auto';
                t.removeAttribute('aria-disabled');
            });
        }
        if (folderInputEl) folderInputEl.value = null; 
        renderSpeedDialItems(); 
    
        let processedFileCount = 0;
        const totalFiles = f.length;
        setSpeedDialStatus(`Iniciando processamento de ${totalFiles} arquivos...`);
    
        try {
            for (const file of f) {
                if (currentOperationSignal.aborted) {
                    throw new DOMException('Folder selection cancelled by user', 'AbortError');
                }
    
                const relativePath = file.webkitRelativePath?.replace(/^\.\//, '');
                if (!relativePath) continue; 
    
                // Early skip for clearly non-relevant files, can be refined
                if (!isMediaFile(file.name) && !ICON_NAME_REGEX.test(file.name) && file.name.toLowerCase() !== 'fav.jpg' && file.name.toLowerCase() !== 'fav.avif') {
                    processedFileCount++; // Count it as processed for status updates
                    if (processedFileCount % 200 === 0) {
                        setSpeedDialStatus(`Processando arquivos... (${processedFileCount}/${totalFiles})`);
                        await delay(1, currentOperationSignal);
                    }
                    continue; 
                }
    
                const pathParts = relativePath.split('/');
                if (pathParts.length < (rootDirName && rootDirName !== '' ? 2 : 1)) {
                     processedFileCount++; continue;
                }
    
                const fileName = pathParts[pathParts.length - 1];
                const prefix = getFirstTwoWords(fileName); 
                let isCover = false;
                let isOriginal = false;
                let inCaminho = false;
                let currentCaminhoName = null;
    
                const capasFolderPath = rootDirName ? `${rootDirName}/${CAPAS_FOLDER_NAME}/` : `${CAPAS_FOLDER_NAME}/`;
                const relativeDir = pathParts.slice(0, -1).join('/') + (pathParts.length > 1 ? '/' : '');
    
                if (relativeDir === capasFolderPath || relativePath.startsWith(capasFolderPath)) {
                    isCover = true;
                    currentCaminhoName = '_CAPAS_';
                } else {
                    for (const caminho of CAMINHO_FOLDER_NAMES) {
                        const caminhoPath = rootDirName ? `${rootDirName}/${caminho}/` : `${caminho}/`;
                        if (relativeDir.startsWith(caminhoPath)) {
                            inCaminho = true;
                            currentCaminhoName = caminho;
                            isOriginal = pathParts.some(part => part.toLowerCase() === ORIGINAIS_FOLDER_NAME.toLowerCase());
                            break;
                        }
                    }
                }
    
                if ((isCover || inCaminho) && isMediaFile(file.name)) { 
                    const fileMetadata = {
                        name: fileName,
                        relativePath: relativePath,
                        isCoverFile: isCover,
                        isOriginal: isOriginal,
                        prefix: prefix,
                        caminhoName: currentCaminhoName,
                        fileRef: file,
                        blobUrl: null, 
                        type: null,    
                        loadSuccess: null, 
                        abortController: null 
                    };
    
                    if (!globalMediaIndex.has(currentCaminhoName)) {
                        globalMediaIndex.set(currentCaminhoName, []);
                    }
                    globalMediaIndex.get(currentCaminhoName).push(fileMetadata);
                }
    
                processedFileCount++;
                if (processedFileCount % 200 === 0) { 
                    setSpeedDialStatus(`Processando arquivos... (${processedFileCount}/${totalFiles})`);
                    await delay(1, currentOperationSignal); 
                }
            }
    
            if (currentOperationSignal.aborted) {
                 throw new DOMException('Folder selection cancelled during processing', 'AbortError');
            }
    
            setSpeedDialStatus(`Indexação completa. Carregando ícones e recursos...`);
            await delay(1, currentOperationSignal); 
    
            await loadSpecificIcons(allSelectedFiles); 
            if (currentOperationSignal.aborted) throw new DOMException('Cancelled after icon loading', 'AbortError');
            
            await loadSpecificFavicon(allSelectedFiles); 
            if (currentOperationSignal.aborted) throw new DOMException('Cancelled after favicon loading', 'AbortError');
    
            activateLuckyFeature(); 
            
            if (!currentOperationSignal.aborted) {
                 setSpeedDialStatus(`Pasta "${rootDirName}" carregada (${totalFiles} arquivos). Escolha um Caminho:`);
            }
    
        } catch (err) {
            if (err.name === 'AbortError') {
                setSpeedDialStatus(`Seleção de pasta cancelada.`, false); // Simpler message
                cleanupUIState();
                mediaFiles.forEach(revokeItemResources);mediaFiles=[];mediaIndex.clear();globalMediaIndex.clear();allSelectedFiles=null;
                if(selectNucleoButtonEl) selectNucleoButtonEl.style.display = 'inline-block';
                if(speedDialOptionsEl) speedDialOptionsEl.style.display = 'none';
                if(document.getElementById('speed-dial-subtitle')) document.getElementById('speed-dial-subtitle').style.display='block';
                renderSpeedDialItems(); 
            } else {
                console.error("Error during folder selection processing:", err);
                setSpeedDialStatus(`Erro ao processar pasta: ${err.message}`, true);
            }
        } finally {
            endOperation(true); 
        }
    }
    async function handleReturnToSpeedDialClick(){if(isLoading)return;const s=beginOperation();try{
        updateMainHeader('Random Media'); // Reset header
        cleanupUIState();if(mediaContainerEl)mediaContainerEl.style.display='none';if(controlsContainerEl)controlsContainerEl.style.display='none';if(speedDialContainerEl)speedDialContainerEl.style.display='flex';document.body.classList.add('initial-load');setSpeedDialStatus("Selecione um Caminho ou carregue uma nova pasta 'Nucleo'.",!1);mediaFiles.forEach(revokeItemResources);mediaFiles=[];mediaIndex.clear();initialViewHistory=[];sessionViewedPrefixes.clear();hideCaminhoSidebar();endOperation(!0);activateLuckyFeature();}catch(e){if(e.name!=='AbortError'){console.error("Error returning to speed dial:",e);setSpeedDialStatus("Erro ao retornar ao início. Verifique o console.",!0)}endOperation(!1); return;}
    }
    function handleGlobalKeyDown(e){if(e.key==='Escape'){if(fullscreenMediaEl&&fullscreenMediaEl.style.display==='flex'){closeFullscreenMedia()} else if (caminhoSidebarEl && caminhoSidebarEl.classList.contains('visible')) {hideCaminhoSidebar();}}}
    document.addEventListener('DOMContentLoaded',()=>{coverOverlayBlur=document.getElementById('cover-overlay-blur');coverOverlay=document.getElementById('cover-overlay');mediaContainerEl=document.getElementById('media-container');loadingIndicatorEl=document.getElementById('loading-indicator');newMediaButton=document.getElementById('new-media');themeToggleButton=document.getElementById('theme-toggle-button');speedDialContainerEl=document.getElementById('speed-dial-container');selectNucleoButtonEl=document.getElementById('select-nucleo-folder');speedDialOptionsEl=document.getElementById('speed-dial-options');speedDialStatusEl=document.getElementById('speed-dial-status');faviconElement=document.getElementById('favicon');folderInputEl=document.getElementById('folder-input');fullscreenMediaEl=document.getElementById('fullscreen-media');fullscreenImgEl=document.getElementById('fullscreen-img');fullscreenVideoEl=document.getElementById('fullscreen-video');rotateButtonEl=document.getElementById('rotate-button');searchInputEl=document.getElementById('search-input');searchSuggestionsEl=document.getElementById('search-suggestions');returnToSpeedDialButton=document.getElementById('return-to-speed-dial');luckyFeatureContainerEl=document.getElementById('lucky-feature-container');luckyImageWrapperEl=document.getElementById('lucky-image-wrapper');luckyImageEl=document.getElementById('lucky-image');luckyImageTextEl=document.getElementById('lucky-image-text');controlsContainerEl = document.querySelector('.controls-container');
    mainHeaderTitleEl = document.getElementById('main-header-title'); // Initialize mainHeaderTitleEl
    caminhoSidebarEl = document.getElementById('caminho-sidebar');
    caminhoSidebarListEl = document.getElementById('caminho-sidebar-list');
    caminhoSidebarTitleEl = document.getElementById('caminho-sidebar-title');
    caminhoSidebarCloseBtnEl = document.getElementById('caminho-sidebar-close-btn');

    const c={coverOverlayBlur,coverOverlay,mediaContainerEl,loadingIndicatorEl,newMediaButton,themeToggleButton,speedDialContainerEl,selectNucleoButtonEl,speedDialOptionsEl,speedDialStatusEl,faviconElement,folderInputEl,fullscreenMediaEl,fullscreenImgEl,fullscreenVideoEl,rotateButtonEl,searchInputEl,searchSuggestionsEl,returnToSpeedDialButton,luckyFeatureContainerEl,luckyImageWrapperEl,luckyImageEl,luckyImageTextEl,controlsContainerEl,caminhoSidebarEl,caminhoSidebarListEl,caminhoSidebarTitleEl,caminhoSidebarCloseBtnEl, mainHeaderTitleEl};const m=Object.entries(c).filter(([_,el])=>!el);if(m.length>0){const e=`Application Error! Required elements not found: ${m.map(([n,_])=>n).join(', ')}`;console.error(e);try{document.body.innerHTML=`<h1 style='color:red; text-align:center;'>Application Error!</h1><p style='text-align:center;'>Required elements not found: ${m.map(([n,_])=>n).join(', ')}</p>`}catch(E){}return}
    updateMainHeader('Random Media'); // Set initial header
    if(controlsContainerEl)controlsContainerEl.style.display='none';loadSpeedDialConfig();renderSpeedDialItems();resetLuckyFeature();function u(){themeToggleButton.textContent=document.body.classList.contains('light-theme')?'Modo Escuro':'Modo Claro'}u();themeToggleButton.addEventListener('click',()=>{document.body.classList.toggle('light-theme');const t=document.body.classList.contains('light-theme')?'light':'dark';try{localStorage.setItem(THEME_KEY,t)}catch(n){console.error("Failed to save theme preference:",n)}u()});selectNucleoButtonEl.addEventListener('click',()=>{if(isLoading)return;if(folderInputEl){folderInputEl.click();setSpeedDialStatus("Aguardando seleção da pasta 'Nucleo'...");initialViewHistory=[];sessionViewedPrefixes.clear();mediaFiles.forEach(revokeItemResources);mediaFiles=[];mediaIndex.clear();allSelectedFiles=null;rootDirName='';cleanupUIState();resetSpeedDialIcons();resetFavicon();resetLuckyFeature(); updateMainHeader('Random Media'); document.body.classList.add('initial-load');if(mediaContainerEl)mediaContainerEl.style.display='none';if(controlsContainerEl)controlsContainerEl.style.display='none';if(document.getElementById('speed-dial-subtitle'))document.getElementById('speed-dial-subtitle').style.display='block';if(speedDialOptionsEl)speedDialOptionsEl.style.display='none';renderSpeedDialItems()}});folderInputEl.addEventListener('change',handleFolderSelection);if(returnToSpeedDialButton)returnToSpeedDialButton.addEventListener('click',handleReturnToSpeedDialClick);if(luckyImageWrapperEl)luckyImageWrapperEl.addEventListener('click',handleLuckyImageClick);
    if(caminhoSidebarCloseBtnEl) caminhoSidebarCloseBtnEl.addEventListener('click', hideCaminhoSidebar);
    newMediaButton.addEventListener('click',async()=>{if(isLoading||!allSelectedFiles||mediaFiles.length===0)return;const s=beginOperation();try{
    updateMainHeader('Random Media'); // Reset header
    resetLuckyFeature();if(speedDialContainerEl) speedDialContainerEl.style.display = 'none'; document.body.classList.remove('initial-load'); cleanupUIState();const n=mediaFiles.filter(i=>!i.isCoverFile);if(n.length>0){if(mediaContainerEl)mediaContainerEl.style.display='block';if(controlsContainerEl)controlsContainerEl.style.display='flex';await displayMedia(getRandomInitialMedia(n,MAX_INITIAL_ITEMS),s,!0);
    const currentPathName = speedDialConfig.find(cfg => {
        if (mediaFiles.length > 0 && mediaFiles[0].relativePath) {
            const parts = mediaFiles[0].relativePath.split('/');
            const basePath = rootDirName ? `${rootDirName}/` : '';
            if (parts.length > (rootDirName ? 1:0) && mediaFiles[0].relativePath.startsWith(basePath)) {
                 const caminhoPart = parts[rootDirName ? 1 : 0];
                 return cfg.originalName === caminhoPart;
            }
        }
        return false;
    })?.originalName;

    if (currentPathName) {
        const uniquePrefixesInPath = Array.from(new Set(n.map(file => file.prefix).filter(Boolean))).sort((a,b) => a.localeCompare(b));
        showCaminhoSidebar(currentPathName, uniquePrefixesInPath);
    } else {
        hideCaminhoSidebar(); 
    }
    
    }else{const e="text-align: center; width: 100%; column-span: all; padding: 20px 0;";if(mediaContainerEl){mediaContainerEl.innerHTML=`<p style="${e}">Nada a exibir (sem mídia regular neste Caminho).</p>`;mediaContainerEl.style.display='block'} if(controlsContainerEl)controlsContainerEl.style.display='flex'; hideCaminhoSidebar();}endOperation(!0)}catch(r){if(r.name!=='AbortError'){console.error("Error displaying new random media:",r);const e="color:var(--error-text); text-align: center; width: 100%; column-span: all; padding: 20px 0;";if(mediaContainerEl){mediaContainerEl.innerHTML=`<p style="${e}">Erro ao exibir nova mídia: ${r.message||'Erro desconhecido'}</p>`;mediaContainerEl.style.display='block'}endOperation(!1)}else{console.log("Display new media cancelled.");endOperation(!1)}}});
    searchInputEl.addEventListener('input',handleSearchInput);
    searchInputEl.addEventListener('blur', e => {
        setTimeout(() => {
            if (!searchSuggestionsEl || !document.activeElement || !document.activeElement.closest('#search-suggestions')) {
                if (searchSuggestionsEl && searchSuggestionsEl.innerHTML !== '') {
                    if (suggestionAbortController) {
                        suggestionAbortController.abort();
                        suggestionAbortController = null;
                    }
                }
                if (searchSuggestionsEl) {
                    searchSuggestionsEl.innerHTML = '';
                    searchSuggestionsEl.style.display = 'none';
                }
            }
        }, 150);
    });
    document.addEventListener('click',hideSuggestionsOnClickOutside);
    searchInputEl.setAttribute('autocomplete','off');
    searchInputEl.disabled=!0;
    searchInputEl.addEventListener('keydown', e => {
        if (!searchSuggestionsEl || searchSuggestionsEl.style.display === 'none' || searchSuggestionsEl.children.length === 0) return;
        const suggestions = Array.from(searchSuggestionsEl.children);
        let activeIndex = suggestions.findIndex(item => item.classList.contains('active'));

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            suggestions[activeIndex]?.classList.remove('active');
            activeIndex = (activeIndex + 1) % suggestions.length;
            suggestions[activeIndex].classList.add('active');
            suggestions[activeIndex].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            suggestions[activeIndex]?.classList.remove('active');
            activeIndex = (activeIndex - 1 + suggestions.length) % suggestions.length;
            suggestions[activeIndex].classList.add('active');
            suggestions[activeIndex].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter') {
            if (activeIndex > -1) {
                e.preventDefault();
                // Trigger the mousedown event which calls handleSuggestionClick
                suggestions[activeIndex].dispatchEvent(new MouseEvent('mousedown', { bubbles: true, cancelable: true }));
            }
        } else if (e.key === 'Escape') {
            if (suggestionAbortController) {
                suggestionAbortController.abort();
                suggestionAbortController = null;
            }
            searchSuggestionsEl.innerHTML = '';
            searchSuggestionsEl.style.display = 'none';
        }
    });
    document.addEventListener('keydown',handleGlobalKeyDown);setSpeedDialStatus("Por favor, selecione a pasta 'Nucleo'.")});
</script>
</body>
</html>


